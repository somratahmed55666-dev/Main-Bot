<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <title>Cashmate Mini App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <script async="async" data-cfasync="false" src="//tg-sdk.monetag.com/js/sdk.js" data-zone-id="3058206"></script> 

    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-database-compat.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* ==================================== */
        /* ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶® CSS */
        /* ==================================== */
        :root {
            --tg-theme-bg-color: #121212; 
            --tg-theme-text-color: #ffffff;
            --tg-theme-link-color: #00bfff;
            --navy-blue: #003366;
            --dark-card: #002147; 
            --jhilmili-gradient: linear-gradient(135deg, #1f1f1f 0%, #000000 100%);
            --footer-bg: #000d1a; 
            --active-color: #00bfff;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            text-align: center; 
            margin: 0; 
            background: var(--jhilmili-gradient);
            color: var(--tg-theme-text-color); 
            min-height: 100vh; 
            padding-bottom: 60px;
        }
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 10px; 
            box-sizing: border-box; 
        }
        h2 { color: white; padding-bottom: 5px; margin-top: 25px; font-size: 1.5em; }
        .card { 
            background-color: var(--dark-card);
            padding: 15px; 
            border-radius: 12px; 
            margin-top: 15px; 
            text-align: left; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            border: 1px solid #005090;
        }
        .main-button, .action-button, .wallet-btn { 
            background-color: #3b5998; 
            color: #ffffff; 
            padding: 12px 20px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            margin: 5px 0;
            width: 100%;
            font-weight: bold;
        }
        .wallet-input, .number-input { 
            width: calc(100% - 22px); 
            padding: 10px; 
            margin-bottom: 10px; 
            border: 1px solid #005090; 
            border-radius: 6px; 
            box-sizing: border-box; 
            background-color: #0d0d0d;
            color: #ffffff;
        }
        .error { color: #ff6347; margin-top: 10px; font-weight: bold; }
        
        /* Tab & Footer Navigation */
        .tab-content { display: none; padding-bottom: 20px; }
        .tab-content.active { display: block; }
        .footer-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-around;
            background-color: var(--footer-bg);
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            border-top: 1px solid #005090;
        }
        .footer-nav button {
            background: none; border: none; color: var(--tg-theme-hint-color); padding: 10px 0;
            flex-grow: 1; font-size: 14px; cursor: pointer; transition: color 0.2s;
            display: flex; flex-direction: column; align-items: center;
        }
        .footer-nav button.active { color: var(--active-color); }
        .footer-nav i { font-size: 20px; margin-bottom: 4px; }
        
        /* Custom Ad View Styles */
        .ad-selection-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 20px; }
        .ad-type-btn { background-color: #0056b3; padding: 15px; border-radius: 10px; font-size: 1.2em; font-weight: bold; }
        .ad-page-header { background-color: var(--dark-card); padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .ad-page-header h3 { margin: 0; color: #00bfff; }
        .ad-page-header p { margin: 5px 0 0 0; color: #28a745; font-weight: bold; }
        .ad-view-btn { 
            background-color: #ffc107; 
            color: black; 
            padding: 15px 25px; 
            font-size: 1.4em; 
            border-radius: 10px; 
            margin-top: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        #main-content, #gate-screen, #admin-panel, #admin-login-screen, #ad-selection-screen, #ad-view-screen { display: none; }
        
        /* New Admin Login Button on Dashboard */
        #admin-link-on-dashboard {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #ffc107;
            font-size: 14px;
            cursor: pointer;
            z-index: 100;
            text-decoration: none;
            padding: 5px 10px;
            border-radius: 5px;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
    </style>
</head>
<body>
    <div class="container" style="position: relative;">
        
        <div id="gate-screen">
             <h2 style="color: white;">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá</h2>
            <p style="color: var(--tg-theme-hint-color);">‡¶è‡¶á ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§</p>
            <a href="https://t.me/cashmate66" target="_blank">
                <button class="main-button" style="background-color: #007bff;">‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡¶®</button>
            </a>
            <p style="margin-top: 20px; color: var(--tg-theme-hint-color);">‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡¶ì‡ßü‡¶æ‡¶∞ ‡¶™‡¶∞ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶ø ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶® ‡¶¨‡¶æ **"‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®"** ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
            <button class="action-button" onclick="checkSubscriptionStatus()">‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>

        <div id="admin-login-screen" style="padding-top: 50px;">
             <h2 style="color: white;">üõ°Ô∏è ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂</h2>
            <input type="password" id="admin-password" class="wallet-input" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®">
            <button class="main-button" onclick="attemptAdminLogin()">‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <p class="error" id="admin-login-error"></p>
            <p style="margin-top: 20px;"><a href="#" onclick="hideAdminLogin(event)" style="color: #4a90e2;">‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</a></p>
        </div>
        
        <div id="main-content">
            
            <a href="#" id="admin-link-on-dashboard" onclick="showAdminLoginFromDashboard(event)">
                <i class="fas fa-user-shield"></i>
            </a>

            <div id="dashboard-tab" class="tab-content active">
                <h2>üìä ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</h2>
                
                <div class="card">
                    <h3 style="color: white; margin-top: 0;">üíµ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</h3>
                    <div class="balance-info">
                        <div>
                            <p style="color: var(--tg-theme-hint-color); margin: 0;">‡¶Æ‡ßÇ‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</p>
                            <p class="value" id="current-balance">‡ß≥ 0.00</p>
                        </div>
                        <div style="border-left: 1px solid #003050;">
                            <p style="color: var(--tg-theme-color); margin: 0;">‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶â‡¶™‡¶æ‡¶∞‡ßç‡¶ú‡¶®</p>
                            <p class="value" id="referral-balance-display">‡ß≥ 0.00</p>
                        </div>
                    </div>
                     <button class="main-button" id="transferRefBtn" onclick="showTransferModal()" style="background-color: #6f42c1; margin-top: 15px;">‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶´‡¶æ‡¶∞</button>
                </div>

                <div class="card">
                    <h3 style="color: white; margin-top: 0;">üìπ ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® ‡¶ì ‡¶â‡¶™‡¶æ‡¶∞‡ßç‡¶ú‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                    <p style="color: var(--tg-theme-hint-color);">‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶∏‡¶´‡¶≤ ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡¶æ‡¶¨‡ßá‡¶®: ‡ß≥6</p>
                    <button class="main-button" id="viewAdBtn" onclick="showAdSelection()" style="background-color: #28a745;">‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
                    <p class="error" id="ad-status" style="display: none;"></p>
                </div>
            </div>
            
            <div id="wallet-tab" class="tab-content">
                <h2>üí∞ ‡¶ì‡¶Ø‡¶º‡¶æ‡¶≤‡ßá‡¶ü ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h2>
                <div class="wallet-card-container">
                    <div class="card-header">
                        <h3>‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶ì‡¶Ø‡¶º‡¶æ‡¶≤‡ßá‡¶ü‡¶∏‡¶Æ‡ßÇ‡¶π</h3>
                        <span id="wallet-count-display" style="font-size: 1.5em; font-weight: bold;">(0/3)</span>
                    </div>
                    <div class="withdraw-icon" onclick="showWithdrawModal()">
                        <i class="fas fa-hand-holding-usd"></i>
                    </div>
                    <ul id="wallet-list-display" class="wallet-list">
                        <li style="color: var(--tg-theme-hint-color);">‡¶ï‡ßã‡¶®‡ßã ‡¶ì‡ßü‡¶æ‡¶≤‡ßá‡¶ü ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶®‡ßá‡¶á‡•§</li>
                    </ul>
                </div>
                <div class="card">
                    <h3 style="color: white; margin-top: 0;">‡¶®‡¶§‡ßÅ‡¶® ‡¶ì‡ßü‡¶æ‡¶≤‡ßá‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                    <p id="wallet-status" style="margin-top: 10px; color: #4a90e2; font-weight: bold;">‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡ß©‡¶ü‡¶ø ‡¶ì‡ßü‡¶æ‡¶≤‡ßá‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá‡•§</p>
                    <select id="payment-method" class="wallet-input">
                        <option value="none">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                        <option value="bkash">‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂</option>
                        <option value="nagad">‡¶®‡¶ó‡¶¶</option>
                    </select>
                    <input type="tel" id="wallet-number-input" class="number-input" 
                        placeholder="01XXXXXXXXX" 
                        value="+88" 
                        maxlength="14" 
                        oninput="enforceWalletInput(this)"
                        required>
                    <button class="wallet-btn" onclick="addWallet()" style="background-color: #00bfff;">‡¶ì‡¶Ø‡¶º‡¶æ‡¶≤‡ßá‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </div>
            </div>

            <div id="referral-tab" class="tab-content">
                <h2>ü§ù ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤</h2>
                <div class="card">
                    <p style="color: var(--tg-theme-hint-color);">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶ï‡ßã‡¶°: <span id="user-referral-code" style="color: #00bfff; font-weight: bold;">Loading...</span></p>
                    <p style="color: var(--tg-theme-hint-color);">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ **‡¶á‡¶â‡¶®‡¶ø‡¶ï ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶≤‡¶ø‡¶Ç‡¶ï**:</p>
                    <span id="user-referral-link-display" style="display: block; margin: 10px 0; padding: 10px; border: 1px dashed #4a90e2; word-wrap: break-word;">Loading...</span>
                    <button class="action-button" onclick="copyReferralLink()" style="background-color: #6f42c1;">‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    <p>‡¶Æ‡ßã‡¶ü ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤: <span id="current-referrals" style="color: #00bfff; font-weight: bold;">0</span> ‡¶ú‡¶®</p>
                    <p>‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡¶æ‡¶¨‡ßá‡¶®: <span style="font-weight: bold; color: #00bfff;">‡ß≥24</span> (‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞‡¶≤‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü)</p>
                    <p style="color: #ff6347;">‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø **‡¶Ü‡¶∞‡ßã <span id="ref-needed" style="font-weight: bold;">23</span> ‡¶ü‡¶ø** ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®‡•§</p>
                </div>
            </div>


            <div id="withdraw-modal" style="display: none; padding-top: 20px;">
                <div class="card" style="background-color: #003050;">
                    <h2 style="color: white; margin-top: 0;">üí∏ ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶∞‡¶ø‡¶ï‡ßÅ‡ßü‡ßá‡¶∏‡ßç‡¶ü</h2>
                    <p style="color: var(--tg-theme-hint-color);">‡¶®‡ßÇ‡¶®‡ßç‡¶Ø‡¶§‡¶Æ ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞: ‡ß≥500 | ‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞: ‡ß≥1000</p>
                    <label for="withdraw-wallet-select" style="display: block; margin-bottom: 5px;">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶ì‡¶Ø‡¶º‡¶æ‡¶≤‡ßá‡¶ü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®:</label>
                    <select id="withdraw-wallet-select" class="wallet-input">
                        <option value="none">‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ì‡ßü‡¶æ‡¶≤‡ßá‡¶ü ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                    </select>
                    <input type="number" id="withdraw-amount" class="wallet-input" placeholder="‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡ß≥500-‡ß≥1000)">
                    <p class="error" id="withdraw-error"></p>
                    <button class="wallet-btn" onclick="requestWithdrawal()" style="background-color: #ffc107; color: black;">‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßÅ‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    <button class="wallet-btn" onclick="hideWithdrawModal()" style="background-color: #dc3545; margin-top: 10px;">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </div>
            </div>

            <div id="transfer-modal" style="display: none; padding-top: 20px;">
                <div class="card" style="background-color: #003050;">
                    <h2 style="color: white; margin-top: 0;">üîÑ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶´‡¶æ‡¶∞</h2>
                    <p style="color: var(--tg-theme-hint-color);">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: <span id="ref-current-balance" style="color: #00bfff; font-weight: bold;">‡ß≥ 0.00</span></p>
                    <p style="color: #ff6347;">**‡¶®‡ßã‡¶ü:** ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶´‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡¶æ‡¶∞‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á‡•§</p>
                    
                    <input type="number" id="transfer-amount-input" class="wallet-input" placeholder="‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶´‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£">
                    <p class="error" id="transfer-error"></p>
                    <button class="wallet-btn" onclick="transferReferralBalance()" style="background-color: #6f42c1;">‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶´‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    <button class="wallet-btn" onclick="hideTransferModal()" style="background-color: #dc3545; margin-top: 10px;">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </div>
            </div>
            
            <div class="footer-nav">
                <button id="nav-dashboard" class="active" onclick="switchTab('dashboard')">
                    <i class="fas fa-home"></i> ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°
                </button>
                <button id="nav-wallet" onclick="switchTab('wallet')">
                    <i class="fas fa-wallet"></i> ‡¶ì‡¶Ø‡¶º‡¶æ‡¶≤‡ßá‡¶ü
                </button>
                <button id="nav-referral" onclick="switchTab('referral')">
                    <i class="fas fa-users"></i> ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤
                </button>
            </div>
        </div>
        
        <div id="admin-panel">
            <h1>üõ°Ô∏è ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</h1>
            <div class="card" style="background-color: #1e1e1e;">
                <button class="action-button" onclick="loadWithdrawals()">‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßÅ‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <h2 style="margin-top: 15px;">‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü‡¶∏‡¶Æ‡ßÇ‡¶π</h2>
                <div style="background-color: #121212; padding: 10px; border-radius: 8px;">
                    <ul id="withdrawal-requests" style="list-style: none; padding: 0;">
                        <li style="color: var(--tg-theme-hint-color);">‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶®‡ßá‡¶á‡•§</li>
                    </ul>
                </div>
            </div>
            <p style="margin-top: 20px;"><a href="#" onclick="hideAdminPanel(event)" style="color: #4a90e2;">‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</a></p>
        </div>

        <div id="ad-selection-screen">
            <h2>üìπ ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶™‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ü‡¶´‡¶∞‡ßç‡¶Æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
            <div class="ad-selection-grid">
                <button class="ad-type-btn" onclick="showAdView('monetag')">
                    <i class="fas fa-play-circle"></i> **Monetag Ad** (‡ß≥6)
                </button>
                <button class="ad-type-btn" onclick="showAdView('google')">
                    <i class="fab fa-google"></i> Google Ad (‡ß≥6) - ‡¶°‡ßá‡¶Æ‡ßã
                </button>
                <button class="ad-type-btn" onclick="showAdView('adstera')">
                    <i class="fas fa-ad"></i> Adsterra Ad (‡ß≥6) - ‡¶°‡ßá‡¶Æ‡ßã
                </button>
            </div>
            <button class="action-button" onclick="resetAdViewAndGoToDashboard()" style="background-color: #dc3545; margin-top: 30px;">‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</button>
        </div>

        <div id="ad-view-screen">
             <div class="ad-page-header">
                <h3 id="ad-header-title">Ad Provider Name</h3>
                <p id="ad-header-payout">‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡ß≥6</p>
            </div>
            <p style="color: var(--tg-theme-hint-color);">**‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶∂‡ßá‡¶∑ ‡¶π‡¶≤‡ßá ‡¶¨‡¶æ ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶≤‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶Ø‡ßã‡¶ó ‡¶π‡¶¨‡ßá‡•§**</p>

            <button class="ad-view-btn" id="ad-show-button" onclick="startAdProcess()">
                ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®
            </button>
            <p class="error" id="ad-view-status" style="display: none;"></p>

            <button class="action-button" onclick="resetAdViewAndGoToDashboard()" style="background-color: #dc3545; margin-top: 30px;">‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</button>
        </div>

    </div>

    <script>
        // ======================================================
        // FIREBASE INITIALIZATION & CONFIG
        // ======================================================
        const firebaseConfig = {
            // üî• ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Firebase API Key 
            apiKey: "AIzaSyCQiJMQrW-nxbF10TcPzyKnsVoqW4QKnJg", 
            authDomain: "cash-mate-3dccc.firebaseapp.com",
            projectId: "cash-mate-3dccc",
            databaseURL: "https://cash-mate-3dccc-default-rtdb.asia-southeast1.firebasedatabase.app",
            storageBucket: "cash-mate-3dccc.firebasestorage.app",
            messagingSenderId: "927592872113",
            appId: "1:927592872113:web:ad6d90632d2b7585c20a90",
            measurementId: "G-C4JNW950XL"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database(app); 
        const dbRefFunc = database.ref.bind(database);
        
        // ======================================================
        // ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶ì ‡¶ó‡ßç‡¶≤‡ßã‡¶¨‡¶æ‡¶≤ ‡¶≠‡ßç‡¶Ø‡¶æ‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶¨‡¶≤ (‚ö†Ô∏è ‡¶è‡¶ó‡ßÅ‡¶≤‡ßã ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®)
        // ======================================================
        const YOUR_BOT_USERNAME = "cash_mate1_bot"; 
        const ADMIN_TELEGRAM_ID = "7156752824"; // üü¢ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ID
        const ADMIN_PASSWORD = "Nokia123456";
        const MONETAG_ZONE_ID = "3058206"; // üü¢ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Monetag Zone ID
        
        // ‚ö†Ô∏è ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Adsterra/Google Direct Link ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¨‡¶∏‡¶æ‡¶® 
        const GOOGLE_AD_LINK = "https://somratahmed55666-dev.github.io/Main-Bot/"; 
        const ADSTERRA_DIRECT_LINK = "https://somratahmed55666-dev.github.io/Main-Bot/"; 
        
        const SUBSCRIPTION_KEY = 'cashmate_subscribed'; // LocalStorage Key

        const MIN_REFERRALS_FOR_WITHDRAW = 23;
        const EARN_PER_AD = 6; 
        const EARN_PER_REFERRAL = 24;
        const MIN_WITHDRAW = 500; 
        const MAX_WITHDRAW = 1000; 
        const MAX_WALLETS = 3; 

        let tgUserId = null; 
        let userData = { balance: 0, referrals: 0, wallets: [] }; 
        let dbRef = null; 
        let adWatchedSuccessfully = false; 
        let currentAdProvider = '';

        // ======================================================
        // CORE FIREBASE & ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡ßá‡¶≠‡¶ø‡¶Ç ‡¶≤‡¶ú‡¶ø‡¶ï
        // ======================================================

        function createAutoReferralID(newUserId) {
             const userRef = dbRefFunc('user_id_map');
             userRef.child(newUserId).once('value', (snapshot) => {
                 if (!snapshot.exists()) {
                     const countRef = dbRefFunc('user_count');
                     countRef.transaction((currentCount) => {
                         const nextId = (currentCount || 0) + 1;
                         userRef.child(newUserId).set(nextId);
                         return nextId;
                     }, (error, committed, snapshot) => {
                         if (error) { console.error("Referral ID creation failed:", error); }
                         else if (committed) { updateUI(); } // ‡¶∏‡¶´‡¶≤ ‡¶π‡¶≤‡ßá UI ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
                     });
                 } else {
                     updateUI(); // ‡¶Ü‡¶á‡¶°‡¶ø ‡¶Ü‡¶ó‡ßá ‡¶•‡ßá‡¶ï‡ßá‡¶á ‡¶•‡¶æ‡¶ï‡¶≤‡ßá UI ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
                 }
             });
        }
        
        function initializeFirebase() {
            if (!tgUserId) return; 
            dbRef = dbRefFunc('users/' + tgUserId);
            
            // üî• ‡¶´‡¶ø‡¶ï‡ßç‡¶∏: ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡¶¨ ‡¶∏‡¶Æ‡ßü ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
            createAutoReferralID(tgUserId); 
            
            dbRef.once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data) {
                    userData = {
                        balance: data.balance || 0,
                        referrals: data.referrals || 0,
                        wallets: data.wallets || [] 
                    };
                    updateUI(); 
                } else {
                    dbRef.set(userData).then(() => {
                        // createAutoReferralID ‡¶ï‡¶≤‡¶ü‡¶ø ‡¶â‡¶™‡¶∞‡ßá ‡¶∏‡¶∞‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá
                        updateUI();
                    });
                }
                
                 dbRef.on('value', (snap) => {
                    const latestData = snap.val();
                    if(latestData) {
                        userData = {
                            balance: latestData.balance || 0,
                            referrals: latestData.referrals || 0,
                            wallets: latestData.wallets || [] 
                        };
                        updateUI(); 
                    }
                 });
            }).catch(error => {
                console.error("Firebase initial load failed:", error);
                Telegram.WebApp.showAlert("‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§ ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
            });
        }
        
        window.saveUserData = function() {
            if (dbRef) {
                dbRef.update(userData)
                    .catch((error) => console.error("Data save failed:", error));
            }
        }
        
        // ======================================================
        // ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ì ‡¶≠‡¶ø‡¶â ‡¶≤‡¶ú‡¶ø‡¶ï (Monetag ‡¶á‡¶®‡ßç‡¶ü‡¶ø‡¶ó‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶∏‡¶π)
        // ======================================================

        window.showAdSelection = function() {
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('ad-selection-screen').style.display = 'block';
            Telegram.WebApp.ready();
        }

        window.showAdView = function(provider) {
            currentAdProvider = provider;
            document.getElementById('ad-selection-screen').style.display = 'none';
            document.getElementById('ad-view-screen').style.display = 'block';
            
            let title = '';
            let btnText = '‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®';
            
            if (provider === 'monetag') {
                title = 'Monetag Ad ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® (Rewarded Interstitial)';
            } else if (provider === 'google') {
                title = 'Google Ad ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®';
                btnText = 'Google Ad-‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶®‡¶§‡ßÅ‡¶® ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶®';
            } else if (provider === 'adstera') {
                title = 'Adsterra Ad ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®';
                btnText = 'Adsterra Ad-‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶®‡¶§‡ßÅ‡¶® ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶®';
            }

            document.getElementById('ad-header-title').textContent = title;
            document.getElementById('ad-show-button').textContent = btnText;
            document.getElementById('ad-show-button').disabled = false;
            document.getElementById('ad-view-status').style.display = 'none';
            
            Telegram.WebApp.ready();
        }
        
        window.resetAdViewAndGoToDashboard = function() {
            document.getElementById('ad-view-screen').style.display = 'none';
            document.getElementById('ad-selection-screen').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            switchTab('dashboard');
        }

        function addBalanceAfterAd(isSuccess = true) {
            const adStatusElement = document.getElementById('ad-view-status');
            
            if (isSuccess) {
                 userData.balance += EARN_PER_AD;
                 saveUserData();
                 Telegram.WebApp.showAlert(`‡ß≥${EARN_PER_AD} ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!`);
                 adStatusElement.textContent = `‡¶∏‡¶´‡¶≤! ‡ß≥${EARN_PER_AD} ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`;
                 adStatusElement.style.color = '#28a745';
            } else {
                 Telegram.WebApp.showAlert("‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶™‡ßÅ‡¶∞‡ßã‡¶™‡ßÅ‡¶∞‡¶ø ‡¶®‡¶æ ‡¶¶‡ßá‡¶ñ‡¶≤‡ßá ‡¶¨‡¶æ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£‡ßá ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡¶®‡¶ø‡•§");
                 adStatusElement.textContent = `‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•! ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡¶®‡¶ø‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§`;
                 adStatusElement.style.color = '#ff6347';
            }
            adStatusElement.style.display = 'block';
            document.getElementById('ad-show-button').disabled = false;
        }

        window.startAdProcess = function() { 
            const adStatusElement = document.getElementById('ad-view-status');
            document.getElementById('ad-show-button').disabled = true;
            adStatusElement.textContent = '‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';
            adStatusElement.style.display = 'block';
            adStatusElement.style.color = '#00bfff';

            if (currentAdProvider === 'monetag') {
                // ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶Ø‡ßá Monetag SDK ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá ‡¶è‡¶¨‡¶Ç ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ü‡¶ø ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶Æ‡¶æ‡¶®
                if (window.Monetag && window.Monetag.adverts) {
                     // üü¢ Monetag Rewarded Interstitial ‡¶≤‡¶ú‡¶ø‡¶ï
                    Monetag.adverts.show({
                        type: 'interstitial' 
                    })
                    .then(function() {
                        // üî• ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶∂‡ßá‡¶∑ ‡¶π‡¶≤‡ßá ‡¶è‡¶á ‡¶¨‡ßç‡¶≤‡¶ï‡¶ü‡¶ø ‡¶è‡¶ï‡ßç‡¶∏‡¶ø‡¶ï‡¶ø‡¶â‡¶ü ‡¶π‡¶¨‡ßá‡•§
                        addBalanceAfterAd(true); // ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
                        document.getElementById('ad-show-button').disabled = false;
                    })
                    .catch(function(error) {
                        // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶≤‡ßã‡¶° ‡¶π‡ßü‡¶®‡¶ø ‡¶¨‡¶æ ‡¶ï‡ßã‡¶®‡ßã ‡¶è‡¶∞‡¶∞ ‡¶π‡ßü‡ßá‡¶õ‡ßá (‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßá ‡¶¶‡¶ø‡ßü‡ßá‡¶õ‡ßá)
                        console.error("Monetag Ad Error:", error);
                        
                        // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶´‡ßá‡¶á‡¶≤ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßÅ‡¶∞‡¶∑‡ßç‡¶ï‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡¶¨‡ßá ‡¶®‡¶æ‡•§
                        addBalanceAfterAd(false); 
                        
                        adStatusElement.textContent = `Monetag ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§`;
                        adStatusElement.style.color = '#ff6347';
                        document.getElementById('ad-show-button').disabled = false;
                    });
                } else {
                     // Monetag SDK ‡¶≤‡ßã‡¶° ‡¶®‡¶æ ‡¶π‡¶≤‡ßá ‡¶°‡ßá‡¶Æ‡ßã ‡¶≤‡¶ú‡¶ø‡¶ï
                     setTimeout(() => { addBalanceAfterAd(true); }, 5000); 
                     adStatusElement.textContent = 'Monetag SDK ‡¶≤‡ßã‡¶° ‡¶π‡ßü‡¶®‡¶ø‡•§ ‡¶°‡ßá‡¶Æ‡ßã ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡ß´ ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶™‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';
                }
            } else if (currentAdProvider === 'google' || currentAdProvider === 'adstera') {
                let link = currentAdProvider === 'google' ? GOOGLE_AD_LINK : ADSTERRA_DIRECT_LINK;
                
                // ‚ö†Ô∏è ‡¶®‡¶§‡ßÅ‡¶® ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨‡ßá ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ì‡¶™‡ßá‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§ (Direct Link-‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)
                window.open(link, '_blank');
                
                adStatusElement.textContent = '‡¶®‡¶§‡ßÅ‡¶® ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨‡ßá ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶ì‡¶™‡ßá‡¶® ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡ß´ ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶™‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶Ø‡ßã‡¶ó ‡¶π‡¶¨‡ßá‡•§';
                setTimeout(() => {
                    addBalanceAfterAd(true);
                }, 5000); // 5 ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶™‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶Ø‡ßã‡¶ó‡ßá‡¶∞ ‡¶°‡ßá‡¶Æ‡ßã ‡¶≤‡¶ú‡¶ø‡¶ï

            } else {
                adStatusElement.textContent = '‡¶Ö‡¶ú‡¶æ‡¶®‡¶æ ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶™‡ßç‡¶∞‡ßã‡¶≠‡¶æ‡¶á‡¶°‡¶æ‡¶∞‡•§';
                document.getElementById('ad-show-button').disabled = false;
            }
        }
        
        // ======================================================
        // ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶´‡¶æ‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï
        // ======================================================

        window.showTransferModal = function() {
            const refBalance = userData.referrals * EARN_PER_REFERRAL;
            document.getElementById('ref-current-balance').textContent = `‡ß≥ ${refBalance.toFixed(2)}`;
            document.getElementById('transfer-modal').style.display = 'block';
            
            // ‡¶Æ‡ßá‡¶á‡¶® ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶è‡¶¨‡¶Ç ‡¶´‡ßÅ‡¶ü‡¶æ‡¶∞ ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® ‡¶π‡¶æ‡¶á‡¶° ‡¶ï‡¶∞‡¶æ
            document.getElementById('dashboard-tab').classList.remove('active');
            document.getElementById('nav-dashboard').classList.remove('active');
        }

        window.hideTransferModal = function() {
            document.getElementById('transfer-modal').style.display = 'none';
            document.getElementById('transfer-amount-input').value = '';
            document.getElementById('transfer-error').textContent = '';
            switchTab('dashboard'); 
        }

        window.transferReferralBalance = function() {
            const amount = parseFloat(document.getElementById('transfer-amount-input').value);
            const refBalance = userData.referrals * EARN_PER_REFERRAL;
            const errorBox = document.getElementById('transfer-error');
            errorBox.textContent = '';

            if (isNaN(amount) || amount <= 0) { errorBox.textContent = '‡¶∏‡¶†‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶¶‡¶ø‡¶®‡•§'; return; }
            if (amount > refBalance) { errorBox.textContent = '‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶®‡ßá‡¶á‡•§'; return; }

            // ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶§‡ßÅ‡¶≤‡ßá ‡¶®‡ßá‡¶ì‡ßü‡¶æ (‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨‡ßá)
            const referralsToDeduct = amount / EARN_PER_REFERRAL;
            
            if (referralsToDeduct > userData.referrals) {
                errorBox.textContent = '‡¶π‡¶ø‡¶∏‡¶æ‡¶¨‡ßá‡¶∞ ‡¶ó‡¶∞‡¶Æ‡¶ø‡¶≤‡•§ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶¨‡ßá‡¶∂‡¶ø ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶´‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ‡•§'; return;
            }
            
            // üî• ‡¶Æ‡ßÇ‡¶≤ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®: ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶Ø‡ßã‡¶ó ‡¶ì ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶ï‡¶Æ‡¶æ‡¶®‡ßã
            userData.balance += amount; 
            userData.referrals -= referralsToDeduct; 
            
            userData.referrals = Math.max(0, userData.referrals); // ‡¶®‡ßá‡¶ó‡ßá‡¶ü‡¶ø‡¶≠ ‡¶π‡¶ì‡ßü‡¶æ ‡¶Ü‡¶ü‡¶ï‡¶æ‡¶®‡ßã

            saveUserData();
            Telegram.WebApp.showAlert(`‡ß≥${amount.toFixed(2)} ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶Æ‡ßÇ‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏‡ßá ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶´‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!`);
            hideTransferModal();
        }

        // ======================================================
        // UI ‡¶è‡¶¨‡¶Ç ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® 
        // ======================================================

        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => { tab.classList.remove('active'); });
            document.querySelectorAll('.footer-nav button').forEach(btn => { btn.classList.remove('active'); });
            document.querySelectorAll('div[id$="-screen"]').forEach(screen => { screen.style.display = 'none'; }); // ‡¶∏‡¶¨ ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®‡ßã
            
            document.getElementById('main-content').style.display = 'block'; // ‡¶Æ‡ßá‡¶á‡¶® ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
            document.getElementById(`${tabName}-tab`).classList.add('active');
            document.getElementById(`nav-${tabName}`).classList.add('active');
            
            Telegram.WebApp.ready();
        }

        window.updateUI = function() {
            const refBalance = userData.referrals * EARN_PER_REFERRAL;
            document.getElementById('current-balance').textContent = `‡ß≥ ${userData.balance.toFixed(2)}`;
            document.getElementById('referral-balance-display').textContent = `‡ß≥ ${refBalance.toFixed(2)}`;
            document.getElementById('current-referrals').textContent = Math.floor(userData.referrals); 
            
            const remainingRefs = Math.max(0, MIN_REFERRALS_FOR_WITHDRAW - Math.floor(userData.referrals));
            document.getElementById('ref-needed').textContent = remainingRefs;
            
            // üî• ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶§‡ßà‡¶∞‡¶ø ‡¶ì ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá (‡¶∏‡¶†‡¶ø‡¶ï ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá)
            dbRefFunc('user_id_map/' + tgUserId).once('value').then(snapshot => {
                const sequentialId = snapshot.val();
                if (sequentialId) {
                    const botUsernameClean = YOUR_BOT_USERNAME.startsWith('@') ? YOUR_BOT_USERNAME.substring(1) : YOUR_BOT_USERNAME;
                    const customLink = `https://t.me/${botUsernameClean}?start=${sequentialId}`;
                    document.getElementById('user-referral-link-display').textContent = customLink;
                } else {
                     document.getElementById('user-referral-link-display').textContent = '‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá... (‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®)';
                }
            });

            // Wallet UI Update Logic...
            const listDisplay = document.getElementById('wallet-list-display');
            const selectWithdrawal = document.getElementById('withdraw-wallet-select');
            listDisplay.innerHTML = '';
            selectWithdrawal.innerHTML = '<option value="none">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶ì‡¶Ø‡¶º‡¶æ‡¶≤‡ßá‡¶ü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>';

            document.getElementById('wallet-count-display').textContent = `(${userData.wallets.length}/${MAX_WALLETS})`;

            if (userData.wallets.length === 0) {
                listDisplay.innerHTML = '<li style="color: var(--tg-theme-hint-color);">‡¶ï‡ßã‡¶®‡ßã ‡¶ì‡ßü‡¶æ‡¶≤‡ßá‡¶ü ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶®‡ßá‡¶á‡•§</li>';
            } else {
                userData.wallets.forEach((wallet, index) => {
                    const listItem = document.createElement('li');
                    const fullNumber = '+88' + wallet.number;
                    const maskedNumber = `${fullNumber.substring(0, 8)} **** ${fullNumber.substring(12)}`; 
                    listItem.innerHTML = `<strong>${wallet.method.toUpperCase()}</strong>: <span class="wallet-number-display">${maskedNumber}</span>
                        <button class="delete-btn" onclick="deleteWallet(${index})">‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶®</button>`;
                    listDisplay.appendChild(listItem);
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${wallet.method.toUpperCase()} (${maskedNumber})`;
                    selectWithdrawal.appendChild(option);
                });
            }

            const statusBox = document.getElementById('wallet-status');
            if (userData.wallets.length >= MAX_WALLETS) {
                 statusBox.textContent = `‡¶Ü‡¶™‡¶®‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö (${MAX_WALLETS}‡¶ü‡¶ø) ‡¶ì‡ßü‡¶æ‡¶≤‡ßá‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®‡•§`;
                 statusBox.style.color = '#ff6347';
            } else {
                 statusBox.textContent = `‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ü‡¶∞‡¶ì ${MAX_WALLETS - userData.wallets.length}‡¶ü‡¶ø ‡¶ì‡ßü‡¶æ‡¶≤‡ßá‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§`;
                 statusBox.style.color = '#4a90e2';
            }
        }
        
        window.enforceWalletInput = function(input) { 
             let value = input.value;
            if (!value.startsWith('+88')) {
                let cleaned = value.replace(/[^0-9]/g, '');
                value = '+88' + cleaned;
            }
            if (value.length > 14) {
                value = value.substring(0, 14);
            }
            if (value.length > 3) {
                let prefix = value.substring(0, 3);
                let numberPart = value.substring(3).replace(/[^0-9]/g, '');
                value = prefix + numberPart;
            }
             if (value.length < 3) {
                value = '+88';
            }
            input.value = value;
        }

        window.addWallet = function() { 
            const method = document.getElementById('payment-method').value;
            let fullNumber = document.getElementById('wallet-number-input').value.trim();
            const statusBox = document.getElementById('wallet-status');
            if (userData.wallets.length >= MAX_WALLETS) {
                 Telegram.WebApp.showAlert(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ${MAX_WALLETS}‡¶ü‡¶ø ‡¶ì‡¶Ø‡¶º‡¶æ‡¶≤‡ßá‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§`);
                 return;
            }
            if (method === 'none') { statusBox.textContent = '‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§'; statusBox.style.color = '#ff6347'; return; }
            if (fullNumber.length !== 14 || !fullNumber.startsWith('+88')) {
                 statusBox.textContent = '‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá +88 ‡¶è‡¶∞ ‡¶™‡¶∞‡ßá ‡ßß‡ßß-‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡ßá‡¶∞ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶®‡•§ ‡¶Æ‡ßã‡¶ü ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞ ‡ßß‡ß™‡¶ü‡¶ø ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§'; 
                 statusBox.style.color = '#ff6347'; 
                 return;
            }
            let numberToSave = fullNumber.substring(3);
            const exists = userData.wallets.some(w => w.number === numberToSave && w.method === method);
            if (exists) {
                statusBox.textContent = '‡¶è‡¶á ‡¶ì‡ßü‡¶æ‡¶≤‡ßá‡¶ü‡¶ü‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶Ü‡¶õ‡ßá‡•§'; statusBox.style.color = '#ff6347'; return;
            }
            const newWallet = { method: method, number: numberToSave };
            userData.wallets.push(newWallet);
            saveUserData();
            document.getElementById('wallet-number-input').value = '+88';
            document.getElementById('payment-method').value = 'none';
            Telegram.WebApp.showAlert(`${method} ‡¶ì‡¶Ø‡¶º‡¶æ‡¶≤‡ßá‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!`);
        }
        
        window.deleteWallet = function(index) { 
            if (confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶è‡¶á ‡¶ì‡¶Ø‡¶º‡¶æ‡¶≤‡ßá‡¶ü‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶¨‡ßá‡¶®?")) {
                userData.wallets.splice(index, 1);
                saveUserData();
                Telegram.WebApp.showAlert('‡¶ì‡ßü‡¶æ‡¶≤‡ßá‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
            }
        }

        window.requestWithdrawal = function() { 
            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            const selectedIndex = document.getElementById('withdraw-wallet-select').value;
            const errorBox = document.getElementById('withdraw-error');
            errorBox.textContent = '';
            
            if (selectedIndex === 'none' || !userData.wallets[selectedIndex]) { errorBox.textContent = '‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶ì‡¶Ø‡¶º‡¶æ‡¶≤‡ßá‡¶ü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§'; return; }
            if (userData.referrals < MIN_REFERRALS_FOR_WITHDRAW) { errorBox.textContent = `‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ${MIN_REFERRALS_FOR_WITHDRAW} ‡¶ü‡¶ø ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®‡•§`; return; }
            if (amount > userData.balance) { errorBox.textContent = '‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶®‡ßá‡¶á‡•§'; return; }
            if (amount < MIN_WITHDRAW || amount > MAX_WITHDRAW) { errorBox.textContent = `‡ß≥${MIN_WITHDRAW} ‡¶•‡ßá‡¶ï‡ßá ‡ß≥${MAX_WITHDRAW}-‡¶è‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§`; return; }

            const selectedWallet = userData.wallets[selectedIndex];
            userData.balance -= amount;
            saveUserData(); 

            const withdrawalData = {
                userId: tgUserId,
                amount: amount,
                wallet: selectedWallet,
                timestamp: new Date().toISOString(),
                status: 'Pending'
            };
            const withdrawRef = dbRefFunc('withdrawals/' + Date.now());
            withdrawRef.set(withdrawalData); 
            Telegram.WebApp.showAlert(`‡ß≥${amount} ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßÅ‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶∏‡¶´‡¶≤ ‡¶π‡ßü‡ßá‡¶õ‡ßá!`);
            hideWithdrawModal();
        }

        window.copyReferralLink = function() { 
            const link = document.getElementById('user-referral-link-display').textContent;
            if (navigator.clipboard) {
                navigator.clipboard.writeText(link).then(() => {
                    Telegram.WebApp.showAlert("‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!");
                });
            } else {
                Telegram.WebApp.showAlert("‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: ‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶∏ ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßá ‡¶®‡¶æ‡•§");
            }
        }

        window.showWithdrawModal = function() { 
            document.getElementById('withdraw-modal').style.display = 'block';
            document.getElementById('dashboard-tab').classList.remove('active');
            document.getElementById('wallet-tab').classList.remove('active');
            document.getElementById('referral-tab').classList.remove('active');
            Telegram.WebApp.ready();
        }

        window.hideWithdrawModal = function() { 
            document.getElementById('withdraw-modal').style.display = 'none';
            switchTab('wallet');
        }

        // ======================================================
        // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶≤‡¶ú‡¶ø‡¶ï
        // ======================================================

        window.showAdminLoginFromDashboard = function(e) { 
             e.preventDefault(); 
             document.getElementById('main-content').style.display = 'none'; 
             document.getElementById('admin-login-screen').style.display = 'block'; 
        }

        window.showAdminLogin = function(e) { 
             e.preventDefault(); 
             document.getElementById('gate-screen').style.display = 'none'; 
             document.getElementById('admin-login-screen').style.display = 'block'; 
        }

        window.hideAdminLogin = function(e) { 
             e.preventDefault(); 
             document.getElementById('admin-login-screen').style.display = 'none'; 
             
             // ‡¶Ø‡¶¶‡¶ø ‡¶∏‡¶æ‡¶¨‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶æ‡¶á‡¶¨ ‡¶ï‡¶∞‡¶æ ‡¶•‡¶æ‡¶ï‡ßá ‡¶§‡¶¨‡ßá ‡¶Æ‡ßá‡¶á‡¶® ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá, ‡¶®‡¶æ ‡¶π‡¶≤‡ßá ‡¶ó‡ßá‡¶ü ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®
             if(localStorage.getItem(SUBSCRIPTION_KEY) === tgUserId) {
                 document.getElementById('main-content').style.display = 'block';
                 switchTab('dashboard');
             } else {
                 document.getElementById('gate-screen').style.display = 'block';
             }
        }
        
        window.hideAdminPanel = function(e) {
             e.preventDefault();
             document.getElementById('admin-panel').style.display = 'none';
             document.getElementById('main-content').style.display = 'block';
             switchTab('dashboard');
        }

        window.attemptAdminLogin = function() {
            const password = document.getElementById('admin-password').value;
            const errorBox = document.getElementById('admin-login-error');
            errorBox.textContent = '';
            
            if (password !== ADMIN_PASSWORD) { errorBox.textContent = '‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤‡•§'; return; }
            if (tgUserId !== ADMIN_TELEGRAM_ID) { errorBox.textContent = `‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶®‡¶®‡•§`; return; }
            
            document.getElementById('admin-login-screen').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            Telegram.WebApp.showAlert('‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ!');
            loadWithdrawals(); 
        }

        window.loadWithdrawals = function() { 
            const listElement = document.getElementById('withdrawal-requests');
            listElement.innerHTML = '<li>‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</li>';
            
            const withdrawRef = dbRefFunc('withdrawals');
            withdrawRef.once('value').then((snapshot) => {
                const requests = snapshot.val();
                listElement.innerHTML = ''; 
                if (!requests) { listElement.innerHTML = '<li style="color: white;">‡¶è‡¶á ‡¶Æ‡ßÅ‡¶π‡ßÇ‡¶∞‡ßç‡¶§‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶®‡ßá‡¶á‡•§</li>'; return; }
                
                Object.keys(requests).reverse().forEach(key => {
                    const req = requests[key];
                    if (req.status !== 'Pending') return;
                    const listItem = document.createElement('li');
                    listItem.style.color = 'white'; 
                    listItem.innerHTML = `
                        <strong>ID: ${req.userId}</strong> | ‡ß≥${req.amount} (${req.wallet.method})<br>
                        Number: +88${req.wallet.number} | Time: ${new Date(req.timestamp).toLocaleString('bn-BD')}
                        <button class="action-btn" onclick="processWithdraw('${key}', 'Paid')" style="background-color: #28a745; color: white; margin-left: 10px;">Paid Mark ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    `;
                    listElement.appendChild(listItem);
                });
                if (listElement.childElementCount === 0) { listElement.innerHTML = '<li style="color: white;">‡¶è‡¶á ‡¶Æ‡ßÅ‡¶π‡ßÇ‡¶∞‡ßç‡¶§‡ßá ‡¶ï‡ßã‡¶®‡ßã Pending ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶®‡ßá‡¶á‡•§</li>'; }
            }).catch(e => { listElement.innerHTML = `<li class="error">‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: ${e.message}</li>`; });
        }
        
        window.processWithdraw = function(key, newStatus) { 
            const withdrawRef = dbRefFunc('withdrawals/' + key);
            withdrawRef.update({ status: newStatus, processedAt: new Date().toISOString() })
                .then(() => {
                    Telegram.WebApp.showAlert(`‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ${key} ‡¶ï‡ßá ${newStatus} ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`);
                    loadWithdrawals(); 
                });
        }
        
        // ======================================================
        // ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶≤‡ßã‡¶° ‡¶≤‡¶ú‡¶ø‡¶ï
        // ======================================================

        window.checkSubscriptionStatus = function() { 
            // ‡¶è‡¶á ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ü‡¶ø ‡¶è‡¶ñ‡¶® ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶ó‡ßá‡¶ü ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® ‡¶•‡ßá‡¶ï‡ßá "‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®" ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá ‡¶ï‡¶≤ ‡¶π‡¶¨‡ßá‡•§
            document.getElementById('gate-screen').style.display = 'none';
            
            // üî• ‡¶°‡ßá‡¶Æ‡ßã ‡¶≤‡¶ú‡¶ø‡¶ï: ‡¶ß‡¶∞‡ßá ‡¶®‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá ‡¶∏‡¶æ‡¶¨‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡¶∂‡¶® ‡¶∏‡¶´‡¶≤
            localStorage.setItem(SUBSCRIPTION_KEY, tgUserId); 
            
            if (tgUserId === ADMIN_TELEGRAM_ID) {
                document.getElementById('admin-login-screen').style.display = 'block';
                return; 
            }
            
            document.getElementById('main-content').style.display = 'block';
            switchTab('dashboard');
            initializeFirebase(); 
        }
        
        function initialLoad() {
            if (window.Telegram && window.Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
                tgUserId = Telegram.WebApp.initDataUnsafe.user.id.toString(); 
                document.getElementById('user-referral-code').textContent = tgUserId;
            } else {
                 // Non-Telegram Environment (Development/Demo)
                 tgUserId = "DEMO_USER_12345";
            }
            
            // 1. ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶ö‡ßá‡¶ï
            if (tgUserId === ADMIN_TELEGRAM_ID) {
                document.getElementById('admin-link-on-dashboard').style.display = 'block';
                document.getElementById('admin-link-on-dashboard').textContent = 'üõ°Ô∏è ‡¶è‡¶°‡¶Æ‡¶ø‡¶®'; // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®‡¶ï‡ßá ‡¶∏‡¶π‡¶ú‡ßá ‡¶ö‡ßá‡¶®‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
            } else {
                document.getElementById('admin-link-on-dashboard').style.display = 'none'; // ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶π‡¶æ‡¶á‡¶°
            }
            
            // 2. ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡ßá‡¶ú ‡¶ö‡ßá‡¶ï
            const subscribedUser = localStorage.getItem(SUBSCRIPTION_KEY);
            
            if (subscribedUser === tgUserId) {
                // ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá ‡¶∏‡¶æ‡¶¨‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶æ‡¶á‡¶¨ ‡¶ï‡¶∞‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá, ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶° ‡¶≤‡ßã‡¶°
                document.getElementById('main-content').style.display = 'block';
                switchTab('dashboard');
                initializeFirebase();
            } else {
                // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡¶¨‡¶æ‡¶∞ ‡¶¨‡¶æ ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶≠‡ßÅ‡¶≤‡ßá ‡¶ó‡ßá‡¶≤‡ßá, ‡¶ó‡ßá‡¶ü ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì
                document.getElementById('gate-screen').style.display = 'block';
            }
            Telegram.WebApp.ready();
        }

        // Initial load check
        if (window.Telegram && window.Telegram.WebApp) {
            Telegram.WebApp.ready();
            initialLoad();
        } else {
             // Non-Telegram Environment
             initialLoad();
        }
    </script>
</body>
</html>
